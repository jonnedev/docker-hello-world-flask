trigger:
- none

pool:
  vmImage: ubuntu-latest

variables:
  IMAGE_REGISTRY: 'ACR'
  IMAGE_REPOSITORY: 'acrdev001jsb.azurecr.io'
  TAG: '$(Build.BuildId)'
  AZURE_SUBSCRIPTION: 'ADO'

stages:
- stage: BuildApp 
  jobs:
    - job: BuildPushImage
      steps: 
      - task: Docker@2
        inputs:
          containerRegistry: '$(IMAGE_REGISTRY)'
          repository: '$(IMAGE_REPOSITORY)'
          command: 'buildAndPush'
          Dockerfile: '**/Dockerfile'
          tags: '$(TAG)'

- stage: ScanImage
  jobs:
    - job: ScanImage
      steps:
      - task: AzureCLI@2
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          scriptType: 'pscore'
          scriptLocation: 'scriptPath'
          scriptPath: '$(Build.SourcesDirectory)/.scripts/ImageScanSummaryAssessmentGate.ps1'
          arguments: '-registryName acrdev001jsb -repository acrdev001jsb.azurecr.io -tag $(Build.BuildId)'
  
- stage: DeployDev
  jobs:
    - job: DeployDev
      steps:
        - task: AzureRmWebAppDeployment@4
          inputs:
            ConnectionType: 'AzureRM'
            azureSubscription: '$(AZURE_SUBSCRIPTION)'
            appType: 'webAppContainer'
            WebAppName: 'webappcontainerjsb001'
            DockerNamespace: '$(IMAGE_REGISTRY)'
            DockerRepository: '$(IMAGE_REPOSITORY)'
            DockerImageTag: '$(TAG)'